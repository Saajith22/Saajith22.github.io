<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Snap IT</title>

    <link rel="stylesheet" href="./css/main.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script async src="./js/opencv.js" type="text/javascript"></script>
  </head>
  <body class="flex flex-col items-center justify-center gap-20 p-10">
    <h1 class="text-4xl font-bold">Convert photo to svg art!</h1>
    <div class="flex flex-col gap-20">
      <div class="flex gap-10">
        <img id="imageSrc" class="holder" />
        <canvas id="output" class="holder"></canvas>
      </div>
      <div>Open Image <input type="file" id="fileInput" name="file" /></div>
    </div>
    <script type="text/javascript">
      const imgElement = document.getElementById("imageSrc");
      const inputElement = document.getElementById("fileInput");
      inputElement.addEventListener(
        "change",
        (e) => {
          imgElement.src = URL.createObjectURL(e.target.files[0]);
        },
        false
      );

      imgElement.addEventListener("load", () => {
        const src = cv.imread(imgElement);
        const dst = cv.Mat.zeros(src.rows, src.cols, cv.CV_8UC3);
        const lines = new cv.Mat();

        cv.cvtColor(src, src, cv.COLOR_RGB2GRAY);
        cv.Canny(src, src, 50, 200, 3);
        cv.HoughLinesP(src, lines, 1, Math.PI / 180, 2, 0, 0);

        const color = new cv.Scalar(255, 255, 255);
        const thickness = 2;

        // const lineImage = cv.Mat.zeros(src.rows, src.cols, cv.CV_8UC1);
        for (let i = 0; i < lines.rows; ++i) {
          const startPoint = new cv.Point(
            lines.data32S[i * 4],
            lines.data32S[i * 4 + 1]
          );

          const endPoint = new cv.Point(
            lines.data32S[i * 4 + 2],
            lines.data32S[i * 4 + 3]
          );

          cv.line(dst, startPoint, endPoint, color, thickness);
        }

        // const contours = new cv.MatVector();
        // const hierarchy = new cv.Mat();
        // cv.findContours(
        //   lineImage,
        //   contours,
        //   hierarchy,
        //   cv.RETR_EXTERNAL,
        //   cv.CHAIN_APPROX_SIMPLE
        // );

        // // Find the largest contour
        // let largestContour = contours.get(0);
        // let maxArea = cv.contourArea(largestContour);
        // for (let i = 1; i < contours.size(); ++i) {
        //   let contour = contours.get(i);
        //   let area = cv.contourArea(contour);
        //   if (area > maxArea) {
        //     largestContour = contour;
        //     maxArea = area;
        //   }
        // }

        // const matty = new cv.MatVector();
        // matty.push_back(largestContour);

        // // Fill the largest contour with black color
        // // const fillColor = new cv.Scalar(0, 255, 0); // Black color
        // cv.drawContours(dst, matty, -1, color, cv.FILLED);

        cv.bitwise_not(dst, dst);
        cv.medianBlur(dst, dst, 5);
        cv.imshow("output", dst);

        //delete stuff
        src.delete();
        dst.delete();
        lines.delete();
      });
    </script>
  </body>
</html>
